{% extends "container/public.html" %}

{% block content %}
<div class="thread">
    <div class="thread-header">
        <div class="thread-title-section">
            <h1>
                <span class="thread-badge thread-badge--private">Private</span>
                {% if let Some(t) = title %}
                    {{ t }}
                {% else %}
                    Conversation with {% for participant in participants %}{{ participant }}{% if !loop.last %}, {% endif %}{% endfor %}
                {% endif %}
            </h1>
            <div class="thread-meta">
                <span class="participants-list">Participants: {% for participant in participants %}{{ participant }}{% if !loop.last %}, {% endif %}{% endfor %}</span>
            </div>
        </div>
        <div class="thread-actions">
            {% if is_archived %}
                <a href="/conversations/archived" class="action-button action-button--secondary">← Back to Archived</a>
                <form action="/conversations/{{ conversation_id }}/unarchive" method="post" style="display: inline;">
                    <input type="hidden" name="csrf_token" value="{{ client.get_csrf_token() }}">
                    <button type="submit" class="action-button">Unarchive</button>
                </form>
            {% else %}
                <a href="/conversations" class="action-button action-button--secondary">← Back to Inbox</a>
                <form action="/conversations/{{ conversation_id }}/archive" method="post" style="display: inline;">
                    <input type="hidden" name="csrf_token" value="{{ client.get_csrf_token() }}">
                    <button type="submit" class="watch-button">Archive</button>
                </form>
            {% endif %}
            <form action="/conversations/{{ conversation_id }}/leave" method="post" style="display: inline;" onsubmit="return confirm('Are you sure you want to leave this conversation? You will no longer receive messages.');">
                <input type="hidden" name="csrf_token" value="{{ client.get_csrf_token() }}">
                <button type="submit" class="watch-button watch-button--danger">Leave</button>
            </form>
        </div>
    </div>

    {% if messages.is_empty() %}
        <div class="message">
            <div class="message-cell message-cell--main" style="text-align: center; padding: 40px;">
                <em>No messages yet. Start the conversation below!</em>
            </div>
        </div>
    {% else %}
        {% for msg in messages %}
        <div class="message {% if msg.user_id == client.get_id() %}message--own{% endif %}">
            <div class="message-cell message-cell--author">
                {{ msg.get_avatar_html(crate::attachment::AttachmentSize::L)|safe }}
                <div class="username">
                    {{ msg.get_url_token()|safe }}
                </div>
                {% if let Some(title) = msg.custom_title.as_ref() %}
                <div class="user-title">{{ title }}</div>
                {% endif %}
                <div class="user-info">
                    {% if let Some(joined) = msg.user_created_at %}
                    <div class="user-joined">
                        Joined: {{ joined.format("%b %Y") }}
                    </div>
                    {% endif %}
                    {% if let Some(post_count) = msg.post_count %}
                    <div class="user-posts">
                        Posts: {{ post_count }}
                    </div>
                    {% endif %}
                    <div class="user-reputation{% if msg.reputation_score > 0 %} reputation-positive{% else if msg.reputation_score < 0 %} reputation-negative{% endif %}">
                        Reputation: {{ msg.reputation_score }}
                    </div>
                </div>
            </div>
            <div class="message-cell message-cell--main">
                <div class="message-header">
                    <div class="message-header--left">
                        <time datetime="{{ msg.created_at }}">{{ msg.created_at.format("%v %r") }}</time>
                    </div>
                    <div class="message-header--right">
                        #{{ loop.index }}
                    </div>
                </div>
                <div class="message-content ugc">
                    {{ msg.content|ugc|safe }}
                </div>
                <div class="message-footer">
                    <div class="message-footer--left">
                        <button type="button" class="quote-btn"
                            data-post-id="{{ msg.id }}"
                            data-username="{{ msg.author_name }}"
                            data-content="{{ msg.content }}"
                            title="Quote this message">Quote</button>
                        <button type="button" class="add-quote-btn"
                            data-post-id="{{ msg.id }}"
                            data-username="{{ msg.author_name }}"
                            data-content="{{ msg.content }}"
                            title="Add to quotes">+Quote</button>
                    </div>
                    <div class="message-footer--right">
                        <div class="reactions-container" data-ugc-id="{{ msg.ugc_id }}" data-csrf="{{ client.get_csrf_token() }}">
                            <div class="reactions-display"></div>
                            {% if client.is_user() && client.get_id() != msg.user_id %}
                            <div class="reactions-picker">
                                <button type="button" class="reaction-picker-toggle" title="Add reaction">+</button>
                                <div class="reaction-picker-dropdown" style="display: none;"></div>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    {% endif %}

    <form id="reply-form" action="/conversations/{{ conversation_id }}/send" method="post">
        <input type="hidden" name="csrf_token" value="{{ client.get_csrf_token() }}">
        <h2>Send Message</h2>
        <div class="bbcode-editor-container">
            {% include "components/bbcode_toolbar.html" %}
            <textarea id="reply-textarea" name="message" rows="6" placeholder="Type your message..." required></textarea>
        </div>
        <button type="submit">Send</button>
    </form>
</div>

<style>
    .thread-badge--private {
        background: #6f42c1;
        color: white;
    }

    .watch-button--danger {
        background: #dc3545;
    }

    .watch-button--danger:hover {
        background: #c82333;
    }

    .message--own {
        background: var(--bg-own-message, #e3f2fd);
    }

    html.dark .message--own {
        background: var(--bg-own-message-dark, #1a3a5c);
    }

    .participants-list {
        color: var(--text-secondary, #666);
    }
</style>
{% endblock %}
