{% extends "container/public.html" %}

{% block content %}
<div class="conversation-container">
    <div class="thread">
        <div class="thread-header">
            <div class="thread-title-section">
                <h1>
                    {% if let Some(t) = title %}
                        {{ t }}
                    {% else %}
                        Conversation with {% for participant in participants %}{{ participant.name }}{% if !loop.last %}, {% endif %}{% endfor %}
                    {% endif %}
                </h1>
            </div>
            <div class="thread-actions">
                {% if is_archived %}
                    <a href="/conversations/archived" class="action-button action-button--secondary">← Back to Archived</a>
                    <form action="/conversations/{{ conversation_id }}/unarchive" method="post" style="display: inline;">
                        <input type="hidden" name="csrf_token" value="{{ client.get_csrf_token() }}">
                        <button type="submit" class="action-button">Unarchive</button>
                    </form>
                {% else %}
                    <a href="/conversations" class="action-button action-button--secondary">← Back to Inbox</a>
                    <form action="/conversations/{{ conversation_id }}/archive" method="post" style="display: inline;">
                        <input type="hidden" name="csrf_token" value="{{ client.get_csrf_token() }}">
                        <button type="submit" class="watch-button">Archive</button>
                    </form>
                {% endif %}
                <form action="/conversations/{{ conversation_id }}/leave" method="post" style="display: inline;" onsubmit="return confirm('Are you sure you want to leave this conversation? You will no longer receive messages.');">
                    <input type="hidden" name="csrf_token" value="{{ client.get_csrf_token() }}">
                    <button type="submit" class="watch-button watch-button--danger">Leave</button>
                </form>
            </div>
        </div>

    {% if messages.is_empty() %}
        <div class="message">
            <div class="message-cell message-cell--main" style="text-align: center; padding: 40px;">
                <em>No messages yet. Start the conversation below!</em>
            </div>
        </div>
    {% else %}
        {% for msg in messages %}
        {% if msg.is_deleted %}
        <div class="message message--deleted">
            <div class="message-cell message-cell--author">
                <div class="username">{{ msg.author_name }}</div>
            </div>
            <div class="message-cell message-cell--main">
                <div class="message-header">
                    <div class="message-header--left">
                        <time datetime="{{ msg.created_at }}">{{ msg.created_at.format("%v %r") }}</time>
                    </div>
                    <div class="message-header--right">
                        #{{ loop.index }}
                    </div>
                </div>
                <div class="message-content">
                    <em>This message has been deleted.</em>
                </div>
            </div>
        </div>
        {% else %}
        <div class="message {% if msg.user_id == client.get_id() %}message--own{% endif %}">
            <div class="message-cell message-cell--author">
                {{ msg.get_avatar_html(crate::attachment::AttachmentSize::L)|safe }}
                <div class="username">
                    {{ msg.get_url_token()|safe }}
                </div>
                {% if let Some(title) = msg.custom_title.as_ref() %}
                <div class="user-title">{{ title }}</div>
                {% endif %}
                <div class="user-info">
                    {% if let Some(joined) = msg.user_created_at %}
                    <div class="user-joined">
                        Joined: {{ joined.format("%b %Y") }}
                    </div>
                    {% endif %}
                    {% if let Some(post_count) = msg.post_count %}
                    <div class="user-posts">
                        Posts: {{ post_count }}
                    </div>
                    {% endif %}
                    <div class="user-reputation{% if msg.reputation_score > 0 %} reputation-positive{% else if msg.reputation_score < 0 %} reputation-negative{% endif %}">
                        Reputation: {{ msg.reputation_score }}
                    </div>
                </div>
            </div>
            <div class="message-cell message-cell--main">
                <div class="message-header">
                    <div class="message-header--left">
                        <time datetime="{{ msg.created_at }}">{{ msg.created_at.format("%v %r") }}</time>
                    </div>
                    <div class="message-header--right">
                        #{{ loop.index }}
                    </div>
                </div>
                <div class="message-content ugc" data-message-id="{{ msg.id }}">
                    {{ msg.content|ugc|safe }}
                </div>
                {% if msg.user_id == client.get_id() %}
                <div class="message-edit-form" data-message-id="{{ msg.id }}" style="display: none;">
                    <form action="/conversations/messages/{{ msg.id }}/edit" method="post">
                        <input type="hidden" name="csrf_token" value="{{ client.get_csrf_token() }}">
                        <div class="bbcode-editor-container">
                            {% include "components/bbcode_toolbar.html" %}
                            <textarea name="content" rows="8" cols="80">{{ msg.content }}</textarea>
                        </div>
                        <div class="edit-form-buttons">
                            <button type="submit">Save</button>
                            <button type="button" class="edit-cancel-btn">Cancel</button>
                        </div>
                    </form>
                </div>
                {% endif %}
                <div class="message-footer">
                    <div class="message-footer--left">
                        <button type="button" class="quote-btn"
                            data-post-id="{{ msg.id }}"
                            data-username="{{ msg.author_name }}"
                            data-content="{{ msg.content }}"
                            title="Quote this message">Quote</button>
                        <button type="button" class="add-quote-btn"
                            data-post-id="{{ msg.id }}"
                            data-username="{{ msg.author_name }}"
                            data-content="{{ msg.content }}"
                            title="Add to quotes">+Quote</button>
                        {% if msg.user_id == client.get_id() %}
                        <button type="button" class="edit-message-btn" data-message-id="{{ msg.id }}">Edit</button>
                        {% endif %}
                        {% if msg.user_id == client.get_id() || client.can("moderate.message.delete_any") %}
                        <form action="/conversations/messages/{{ msg.id }}/delete" method="post" style="display: inline;" onsubmit="return confirm('Are you sure you want to delete this message?');">
                            <input type="hidden" name="csrf_token" value="{{ client.get_csrf_token() }}">
                            <button type="submit" class="delete-message-btn">Delete</button>
                        </form>
                        {% endif %}
                    </div>
                    <div class="message-footer--right">
                        <div class="reactions-container" data-ugc-id="{{ msg.ugc_id }}" data-csrf="{{ client.get_csrf_token() }}">
                            <div class="reactions-display"></div>
                            {% if client.is_user() && client.get_id() != msg.user_id %}
                            <div class="reactions-picker">
                                <button type="button" class="reaction-picker-toggle" title="Add reaction">+</button>
                                <div class="reaction-picker-dropdown" style="display: none;"></div>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% if let Some(signature_html) = msg.get_signature_html() %}
                <div class="message-signature">
                    <hr class="signature-divider" />
                    <div class="signature-content">{{ signature_html|safe }}</div>
                </div>
                {% endif %}
            </div>
        </div>
        {% endif %}
        {% endfor %}
    {% endif %}

    <form id="reply-form" action="/conversations/{{ conversation_id }}/send" method="post">
        <input type="hidden" name="csrf_token" value="{{ client.get_csrf_token() }}">
        <h2>Send Message</h2>
        <div class="bbcode-editor-container">
            {% include "components/bbcode_toolbar.html" %}
            <textarea id="reply-textarea" name="message" rows="6" placeholder="Type your message..." required></textarea>
        </div>
        <button type="submit">Send</button>
    </form>
    </div>

    <aside class="conversation-sidebar">
        <div class="sidebar-section">
            <h3>Participants ({{ participants.len() }})</h3>
            <ul class="participant-list">
                {% for participant in participants %}
                <li class="participant-item">
                    <a href="/members/{{ participant.user_id }}" class="participant-name">
                        {{ participant.name }}
                        {% if participant.is_creator %}
                            <span class="creator-badge" title="Conversation creator">★</span>
                        {% endif %}
                    </a>
                    {% if is_creator && participant.user_id != client.get_id().unwrap_or(0) %}
                    <form action="/conversations/{{ conversation_id }}/kick" method="post" class="kick-form" onsubmit="return confirm('Remove {{ participant.name }} from this conversation?');">
                        <input type="hidden" name="csrf_token" value="{{ client.get_csrf_token() }}">
                        <input type="hidden" name="user_id" value="{{ participant.user_id }}">
                        <button type="submit" class="kick-btn" title="Remove from conversation">×</button>
                    </form>
                    {% endif %}
                </li>
                {% endfor %}
            </ul>
        </div>

        {% if is_creator %}
        <div class="sidebar-section">
            <h3>Invite User</h3>
            <form action="/conversations/{{ conversation_id }}/invite" method="post" class="invite-form">
                <input type="hidden" name="csrf_token" value="{{ client.get_csrf_token() }}">
                <input type="text" name="username" placeholder="Username" class="invite-input" required autocomplete="off" data-autocomplete-url="/api/users/search">
                <button type="submit" class="invite-btn">Invite</button>
            </form>
        </div>
        {% endif %}
    </aside>
</div>

<style>
    .conversation-container {
        display: flex;
        gap: 1rem;
    }

    .conversation-container .thread {
        flex: 1;
        min-width: 0;
    }

    .conversation-sidebar {
        width: 250px;
        flex-shrink: 0;
    }

    .sidebar-section {
        background: var(--bg-secondary, #f5f5f5);
        border: 1px solid var(--border-color, #ddd);
        border-radius: 4px;
        padding: 1rem;
        margin-bottom: 1rem;
    }

    html.dark .sidebar-section {
        background: var(--bg-secondary-dark, #2a2a2a);
        border-color: var(--border-color-dark, #444);
    }

    .sidebar-section h3 {
        margin: 0 0 0.75rem 0;
        font-size: 0.9rem;
        border-bottom: 1px solid var(--border-color, #ddd);
        padding-bottom: 0.5rem;
    }

    html.dark .sidebar-section h3 {
        border-color: var(--border-color-dark, #444);
    }

    .participant-list {
        list-style: none;
        margin: 0;
        padding: 0;
    }

    .participant-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.35rem 0;
        border-bottom: 1px solid var(--border-color-light, #eee);
    }

    html.dark .participant-item {
        border-color: var(--border-color-dark, #444);
    }

    .participant-item:last-child {
        border-bottom: none;
    }

    .participant-name {
        text-decoration: none;
        color: inherit;
    }

    .participant-name:hover {
        text-decoration: underline;
    }

    .creator-badge {
        color: gold;
        margin-left: 0.25rem;
    }

    .kick-form {
        display: inline;
    }

    .kick-btn {
        background: #dc3545;
        color: white;
        border: none;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        font-size: 14px;
        line-height: 1;
        cursor: pointer;
        padding: 0;
    }

    .kick-btn:hover {
        background: #c82333;
    }

    .invite-form {
        display: flex;
        gap: 0.5rem;
    }

    .invite-input {
        flex: 1;
        padding: 0.5rem;
        border: 1px solid var(--border-color, #ddd);
        border-radius: 4px;
        font-size: 0.9rem;
    }

    html.dark .invite-input {
        background: var(--bg-input-dark, #333);
        border-color: var(--border-color-dark, #555);
        color: var(--text-color-dark, #eee);
    }

    .invite-btn {
        padding: 0.5rem 1rem;
        background: var(--primary-color, #007bff);
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.9rem;
    }

    .invite-btn:hover {
        background: var(--primary-color-hover, #0056b3);
    }

    .invite-dropdown {
        position: absolute;
        left: 0;
        right: 0;
        top: 100%;
        background: var(--bg-primary, #fff);
        border: 1px solid var(--border-color, #ddd);
        border-radius: 4px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        z-index: 100;
        max-height: 200px;
        overflow-y: auto;
        margin-top: 2px;
    }

    html.dark .invite-dropdown {
        background: var(--bg-primary-dark, #1a1a1a);
        border-color: var(--border-color-dark, #444);
    }

    .invite-dropdown-item {
        padding: 0.5rem 0.75rem;
        cursor: pointer;
    }

    .invite-dropdown-item:hover,
    .invite-dropdown-item.selected {
        background: var(--bg-hover, #f0f0f0);
    }

    html.dark .invite-dropdown-item:hover,
    html.dark .invite-dropdown-item.selected {
        background: var(--bg-hover-dark, #333);
    }

    @media (max-width: 768px) {
        .conversation-container {
            flex-direction: column-reverse;
        }

        .conversation-sidebar {
            width: 100%;
        }
    }

    .watch-button--danger {
        background: #dc3545;
    }

    .watch-button--danger:hover {
        background: #c82333;
    }

    .message--own {
        background: var(--bg-own-message, #e3f2fd);
    }

    html.dark .message--own {
        background: var(--bg-own-message-dark, #1a3a5c);
    }

    .edit-message-btn,
    .delete-message-btn {
        background: none;
        border: none;
        color: inherit;
        cursor: pointer;
        padding: 0;
        font: inherit;
    }

    .edit-message-btn:hover,
    .delete-message-btn:hover {
        text-decoration: underline;
    }

    .delete-message-btn {
        color: #dc3545;
    }
</style>

<script nonce="{{ client.get_nonce() }}">
document.addEventListener('DOMContentLoaded', function() {
    // Edit message button handler
    document.querySelectorAll('.edit-message-btn').forEach(function(btn) {
        btn.addEventListener('click', function() {
            const messageId = this.dataset.messageId;
            const content = document.querySelector('.message-content[data-message-id="' + messageId + '"]');
            const editForm = document.querySelector('.message-edit-form[data-message-id="' + messageId + '"]');

            if (content && editForm) {
                content.style.display = 'none';
                editForm.style.display = 'block';
            }
        });
    });

    // Cancel edit button handler
    document.querySelectorAll('.edit-cancel-btn').forEach(function(btn) {
        btn.addEventListener('click', function() {
            const editForm = this.closest('.message-edit-form');
            const messageId = editForm.dataset.messageId;
            const content = document.querySelector('.message-content[data-message-id="' + messageId + '"]');

            if (content && editForm) {
                editForm.style.display = 'none';
                content.style.display = 'block';
            }
        });
    });

    // Invite user autocomplete
    const inviteInput = document.querySelector('.invite-input');
    if (inviteInput) {
        let dropdown = null;
        let results = [];
        let selectedIndex = 0;
        let debounceTimer = null;

        function createDropdown() {
            const dd = document.createElement('div');
            dd.className = 'invite-dropdown';
            inviteInput.parentElement.style.position = 'relative';
            inviteInput.parentElement.appendChild(dd);
            return dd;
        }

        function hideDropdown() {
            if (dropdown) {
                dropdown.style.display = 'none';
            }
            results = [];
            selectedIndex = 0;
        }

        function showDropdown(users) {
            results = users;
            selectedIndex = 0;

            if (!dropdown) {
                dropdown = createDropdown();
            }

            if (results.length === 0) {
                dropdown.style.display = 'none';
                return;
            }

            dropdown.innerHTML = results.map((user, i) =>
                '<div class="invite-dropdown-item' + (i === 0 ? ' selected' : '') + '" data-username="' + user.username + '">' +
                user.username + '</div>'
            ).join('');

            dropdown.style.display = 'block';

            dropdown.querySelectorAll('.invite-dropdown-item').forEach(function(item) {
                item.addEventListener('mousedown', function(e) {
                    e.preventDefault();
                    inviteInput.value = this.dataset.username;
                    hideDropdown();
                    inviteInput.focus();
                });
            });
        }

        function updateSelection(newIndex) {
            if (results.length === 0) return;
            selectedIndex = Math.max(0, Math.min(newIndex, results.length - 1));
            dropdown.querySelectorAll('.invite-dropdown-item').forEach(function(item, i) {
                item.classList.toggle('selected', i === selectedIndex);
            });
        }

        async function searchUsers(query) {
            if (!query || query.length < 1) return [];
            try {
                const res = await fetch('/api/users/search?q=' + encodeURIComponent(query));
                if (!res.ok) return [];
                return await res.json();
            } catch (e) {
                return [];
            }
        }

        inviteInput.addEventListener('input', function() {
            const query = this.value.trim();
            clearTimeout(debounceTimer);
            if (query.length < 1) {
                hideDropdown();
                return;
            }
            debounceTimer = setTimeout(async function() {
                const users = await searchUsers(query);
                showDropdown(users);
            }, 150);
        });

        inviteInput.addEventListener('keydown', function(e) {
            if (!dropdown || dropdown.style.display === 'none') return;

            if (e.key === 'ArrowDown') {
                e.preventDefault();
                updateSelection(selectedIndex + 1);
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                updateSelection(selectedIndex - 1);
            } else if (e.key === 'Enter' && results.length > 0) {
                e.preventDefault();
                inviteInput.value = results[selectedIndex].username;
                hideDropdown();
            } else if (e.key === 'Escape') {
                hideDropdown();
            }
        });

        inviteInput.addEventListener('blur', function() {
            setTimeout(hideDropdown, 200);
        });
    }
});
</script>
{% endblock %}
