{% if post.deleted_at.is_some() && !client.can_read_post(post) %}
{# Post is deleted and user cannot read it - show placeholder #}
<div class="message message--deleted">
    <div class="message-cell message-cell--author">
        <div class="username">[Deleted]</div>
    </div>
    <div class="message-cell message-cell--main">
        <div class="message-holder">
            <em>This post has been deleted.</em>
        </div>
    </div>
</div>
{% else if client.can_read_post(post) %}
{# User can read this post #}
<div class="message">
    <div class="message-cell message-cell--author">
        {% if let Some(user) = user %}
        {{ user.get_avatar_html(crate::attachment::AttachmentSize::L)|safe }}
        <div class="username">
            {{ user.get_url_token()|safe }}
            {% if post.user_id == thread.user_id %}
            <span class="user-badge user-badge--op" title="Thread Starter">OP</span>
            {% endif %}
        </div>
        {% if let Some(title) = user.custom_title.as_ref() %}
        <div class="user-title">{{ title }}</div>
        {% endif %}
        <div class="user-info">
            <div class="user-joined">
                Joined: {{ user.created_at.format("%b %Y") }}
            </div>
            {% if let Some(post_count) = user.post_count %}
            <div class="user-posts">
                Posts: {{ post_count }}
            </div>
            {% endif %}
            <div class="user-reputation{% if user.reputation_score > 0 %} reputation-positive{% else if user.reputation_score < 0 %} reputation-negative{% endif %}">
                Reputation: {{ user.reputation_score }}
            </div>
        </div>
        {% else %}
        {# TODO: l10n #}
        <div class="username">Guest</div>
        {% endif %}
    </div>
    <div class="message-cell message-cell--main">
        {% if post.deleted_at.is_none() %}
        <div class="message-header">
            <div class="message-header--left">
                <time datetime="{{ post.created_at }}">{{ post.created_at.format("%v %r") }}</time>
                {% if post.created_at != post.updated_at %}updated at <time datetime="{{ post.updated_at }}">{{
                    post.updated_at.format("%v %r") }}</time>{% endif %}
            </div>
            <div class="message-header--right">
                <a href="/threads/{{ post.thread_id }}/post-{{ post.id }}" title="Permanent link">#{{ post.position
                    }}</a>
            </div>
        </div>

        {% match post.content %}{% when Some with (content) %}
        <div class="message-content" data-post-id="{{ post.id }}">
            {% include "ugc/ugc.html" %}
        </div>
        {% if client.can_update_post(post) %}
        <div class="message-edit-form" data-post-id="{{ post.id }}" style="display: none;">
            <form action="/posts/{{ post.id }}/edit" method="post">
                <input type="hidden" name="csrf_token" value="{{ client.get_csrf_token() }}">
                <div class="bbcode-editor-container">
                    {% include "components/bbcode_toolbar.html" %}
                    <textarea name="content" rows="8" cols="80"
                        data-char-limit="{% if client.can("moderate.post.edit") %}100000{% else %}50000{% endif %}">{{ content }}</textarea>
                </div>
                <div class="edit-form-buttons">
                    <button type="submit">Save</button>
                    <button type="button" class="edit-cancel-btn">Cancel</button>
                </div>
            </form>
        </div>
        {% endif %}
        {% when None %}{% endmatch %}

        {% match post_attachments %}{% when Some with (post_attachments) %}
        <div class="message-attachments">
            {% for attachment in post_attachments %}
            <div class="attachment">ðŸ“Ž <a href="{{ attachment.get_download_url() }}">{{ attachment.ugc_filename }}</a>
            </div>
            {% endfor %}
        </div>
        {% when None %}{% endmatch %}

        <footer class="message-footer">
            {# Reactions summary bar #}
            <div class="reactionsBar" data-ugc-id="{{ post.ugc_id }}">
                <ul class="reactionsSummary"></ul>
            </div>

            {# Action bar #}
            <div class="message-actionBar actionBar">
                <div class="actionBar-set actionBar-set--external">
                    {% if client.is_user() && client.get_id() != post.user_id %}
                    <div class="reactions-container" data-ugc-id="{{ post.ugc_id }}" data-csrf="{{ client.get_csrf_token() }}">
                        <div class="reactions-picker">
                            <button type="button" class="actionBar-action reaction-picker-toggle" title="Add reaction">React</button>
                            <div class="reaction-picker-dropdown" style="display: none;"></div>
                        </div>
                    </div>
                    {% endif %}

                    {% if client.is_user() %}
                    <button type="button" class="actionBar-action actionBar-action--quote quote-btn"
                        data-post-id="{{ post.id }}"
                        data-thread-id="{{ post.thread_id }}"
                        data-username="{% if let Some(u) = user %}{{ u.name }}{% else %}Guest{% endif %}"
                        data-content="{% match post.content %}{% when Some with (c) %}{{ c }}{% when None %}{% endmatch %}"
                        title="Quote this post">Quote</button>
                    <button type="button" class="actionBar-action actionBar-action--multiQuote add-quote-btn"
                        data-post-id="{{ post.id }}"
                        data-thread-id="{{ post.thread_id }}"
                        data-username="{% if let Some(u) = user %}{{ u.name }}{% else %}Guest{% endif %}"
                        data-content="{% match post.content %}{% when Some with (c) %}{{ c }}{% when None %}{% endmatch %}"
                        title="Add to multi-quote">+Quote</button>
                    {% endif %}
                </div>

                <div class="actionBar-set actionBar-set--internal">
                    {% if client.can_update_post(post) %}
                    <button type="button" class="actionBar-action actionBar-action--edit quote-btn edit-post-btn" data-post-id="{{ post.id }}">Edit</button>
                    <a href="/posts/{{ post.id }}/delete" class="actionBar-action actionBar-action--delete quote-btn">Delete</a>
                    {% endif %}
                    {% if client.is_user() %}
                    <button type="button" class="actionBar-action actionBar-action--report quote-btn report-btn"
                        data-content-type="post"
                        data-content-id="{{ post.id }}"
                        data-csrf="{{ client.get_csrf_token() }}"
                        title="Report this post">Report</button>
                    {% endif %}
                    {% if post.created_at != post.updated_at && client.can_update_post(post) %}
                    <a href="/posts/{{ post.id }}/history" class="actionBar-action actionBar-action--history quote-btn">History</a>
                    {% endif %}
                </div>
            </div>
        </footer>

        {% if let Some(user) = user %}
        {% if let Some(signature_html) = user.get_signature_html() %}
        <div class="message-signature">
            <hr class="signature-divider" />
            <div class="signature-content">{{ signature_html|safe }}</div>
        </div>
        {% endif %}
        {% endif %}
        {% else %}
        <div class="message-holder">
            <em>This message was deleted.</em>
            {% if let Some(deleted_at) = post.deleted_at %}
            <div style="font-size: 0.9em; color: #666; margin-top: 5px;">
                Deleted on {{ deleted_at.format("%v %r") }}
            </div>
            {% endif %}
        </div>
        {% endif %}
    </div>
</div>
{% endif %}