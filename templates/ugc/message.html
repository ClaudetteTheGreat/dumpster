{% if post.deleted_at.is_some() && !client.can_read_post(post) %}
{# Post is deleted and user cannot read it - show placeholder #}
<div class="message message--deleted">
    <div class="message-cell message-cell--author">
        <div class="username">[Deleted]</div>
    </div>
    <div class="message-cell message-cell--main">
        <div class="message-holder">
            <em>This post has been deleted.</em>
        </div>
    </div>
</div>
{% else if client.can_read_post(post) %}
{# User can read this post #}
<div class="message">
    <div class="message-cell message-cell--author">
        {% if let Some(user) = user %}
        {{ user.get_avatar_html(crate::attachment::AttachmentSize::L)|safe }}
        <div class="username">
            {{ user.get_url_token()|safe }}
            {% if post.user_id == thread.user_id %}
            <span class="user-badge user-badge--op" title="Thread Starter">OP</span>
            {% endif %}
        </div>
        {% if let Some(title) = user.custom_title.as_ref() %}
        <div class="user-title">{{ title }}</div>
        {% endif %}
        <div class="user-info">
            <div class="user-joined">
                Joined: {{ user.created_at.format("%b %Y") }}
            </div>
            {% if let Some(post_count) = user.post_count %}
            <div class="user-posts">
                Posts: {{ post_count }}
            </div>
            {% endif %}
            <div class="user-reputation{% if user.reputation_score > 0 %} reputation-positive{% else if user.reputation_score < 0 %} reputation-negative{% endif %}">
                Reputation: {{ user.reputation_score }}
            </div>
        </div>
        {% else %}
        {# TODO: l10n #}
        <div class="username">Guest</div>
        {% endif %}
    </div>
    <div class="message-cell message-cell--main">
        {% if post.deleted_at.is_none() %}
        <div class="message-header">
            <div class="message-header--left">
                <time datetime="{{ post.created_at }}">{{ post.created_at.format("%v %r") }}</time>
                {% if post.created_at != post.updated_at %}updated at <time datetime="{{ post.updated_at }}">{{
                    post.updated_at.format("%v %r") }}</time>{% endif %}
            </div>
            <div class="message-header--right">
                <a href="/threads/{{ post.thread_id }}/post-{{ post.id }}" title="Permanent link">#{{ post.position
                    }}</a>
            </div>
        </div>

        {% match post.content %}{% when Some with (content) %}
        <div class="message-content">
            {% include "ugc/ugc.html" %}
        </div>
        {% when None %}{% endmatch %}

        {% match post_attachments %}{% when Some with (post_attachments) %}
        <div class="message-attachments">
            {% for attachment in post_attachments %}
            <div class="attachment">ðŸ“Ž <a href="{{ attachment.get_download_url() }}">{{ attachment.ugc_filename }}</a>
            </div>
            {% endfor %}
        </div>
        {% when None %}{% endmatch %}

        <div class="message-footer">
            <div class="message-footer--left">
                {# Mod Checkbox, Report, Delete, IP, Warn #}
                {% if client.is_user() %}
                <button type="button" class="quote-btn"
                    data-post-id="{{ post.id }}"
                    data-username="{% if let Some(u) = user %}{{ u.name }}{% else %}Guest{% endif %}"
                    data-content="{% match post.content %}{% when Some with (c) %}{{ c }}{% when None %}{% endmatch %}"
                    title="Quote this post">Quote</button>
                <button type="button" class="add-quote-btn"
                    data-post-id="{{ post.id }}"
                    data-thread-id="{{ post.thread_id }}"
                    data-username="{% if let Some(u) = user %}{{ u.name }}{% else %}Guest{% endif %}"
                    data-content="{% match post.content %}{% when Some with (c) %}{{ c }}{% when None %}{% endmatch %}"
                    title="Add to quotes">+Quote</button>
                <button type="button" class="report-btn"
                    data-content-type="post"
                    data-content-id="{{ post.id }}"
                    data-csrf="{{ client.get_csrf_token() }}"
                    title="Report this post">Report</button>
                {% if client.can_update_post(post) %}<a href="/posts/{{ post.id }}/edit">Edit</a>{% endif %}
                {% if client.can_update_post(post) %}<a href="/posts/{{ post.id }}/delete">Delete</a>{% endif %}
                {% if post.created_at != post.updated_at && client.can_update_post(post) %}<a
                    href="/posts/{{ post.id }}/history">History</a>{% endif %}
                {% endif %}
            </div>
            <div class="message-footer--right">
                {# Reactions #}
                <div class="reactions-container" data-ugc-id="{{ post.ugc_id }}" data-csrf="{{ client.get_csrf_token() }}">
                    <div class="reactions-display"></div>
                    {% if client.is_user() && client.get_id() != post.user_id %}
                    <div class="reactions-picker">
                        <button type="button" class="reaction-picker-toggle" title="Add reaction">+</button>
                        <div class="reaction-picker-dropdown" style="display: none;"></div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        {% if let Some(user) = user %}
        {% if let Some(signature_html) = user.get_signature_html() %}
        <div class="message-signature">
            <hr class="signature-divider" />
            <div class="signature-content">{{ signature_html|safe }}</div>
        </div>
        {% endif %}
        {% endif %}
        {% else %}
        <div class="message-holder">
            <em>This message was deleted.</em>
            {% if let Some(deleted_at) = post.deleted_at %}
            <div style="font-size: 0.9em; color: #666; margin-top: 5px;">
                Deleted on {{ deleted_at.format("%v %r") }}
            </div>
            {% endif %}
        </div>
        {% endif %}
    </div>
</div>
{% endif %}